(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[655],{71605:function(t,e,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Pos/Posreturn",function(){return a(63450)}])},63450:function(t,e,a){"use strict";a.r(e),a.d(e,{default:function(){return q}});var n=a(85893),i=a(67294),r=a(80861),o=a(30258),s=a(30506),c=a(17503),d=a(70529),l=a(76964),u=a(38761),h=a(39816),x=a(10227),m=a(78021),p=a(32335),y=a(90928),f=a(35054),j=a(17636),g=a(70020),w=a(63291),v=a(61492),k=a(79631),Z=a(12102),P=a(32844),b=a(39828),S=a(94205),A=a(91819);a(18159);let{Title:I,Text:C}=r.default,{Option:N}=o.default,{Header:F,Content:D,Footer:R}=s.default,T=i.memo(t=>{let{returnItems:e,onQuantityChange:a,onDiscountChange:i,onDeleteItem:r}=t;return(0,n.jsx)(c.Z,{dataSource:e,columns:[{title:"ID",dataIndex:"id",key:"id",width:100},{title:"Item",dataIndex:"itemName",key:"itemName",width:200},{title:"Stock",dataIndex:"stock",key:"stock",width:100},{title:"TP (Trade Price)",dataIndex:"tpRate",key:"tpRate",width:100,render:t=>void 0!==t?"₹".concat(t.toFixed(2)):"N/A"},{title:"Quantity",dataIndex:"quantity",key:"quantity",width:100,render:(t,e)=>(0,n.jsx)(d.Z,{id:e.id,value:e.quantity,onChange:t=>a(e.id,t)})},{title:"Unit Price",dataIndex:"packRetailPrice",key:"packRetailPrice",width:100,render:t=>void 0!==t?"₹".concat(t.toFixed(2)):"N/A"},{title:"Discount (%)",dataIndex:"discount",key:"discount",width:100,render:(t,e)=>(0,n.jsx)(d.Z,{min:0,max:100,value:e.discount,onChange:t=>i(e.id,t)})},{title:"Total",dataIndex:"totalAmount",key:"totalAmount",width:100,render:t=>void 0!==t?"₹".concat(t.toFixed(2)):"N/A"},{title:"Action",key:"action",width:100,render:(t,e)=>(0,n.jsx)(l.ZP,{type:"text",danger:!0,icon:(0,n.jsx)(w.Z,{}),onClick:()=>r(e.id)})}],pagination:!1,rowKey:"id"})});function q(){let[t,e]=(0,i.useState)([]),[a,r]=(0,i.useState)([]),[w,q]=(0,i.useState)(1),[E,_]=(0,i.useState)(""),[Q,L]=(0,i.useState)("cash"),[z,M]=(0,i.useState)(0),[J,B]=(0,i.useState)(""),[K,U]=(0,i.useState)([]),[H,O]=(0,i.useState)(null),[Y,X]=(0,i.useState)(!1),[G,V]=(0,i.useState)(!1),W=(0,i.useRef)(null);(0,i.useEffect)(()=>{(async()=>{let t=await $(),a=await tt(),n=await te();e(t),q(a),U(n)})()},[]),(0,i.useEffect)(()=>{let t=setInterval(async()=>{e(await $())},1e3);return()=>clearInterval(t)},[]);let $=async()=>{try{return(await (0,b.PL)((0,b.hJ)(S.db,"items"))).docs.map(t=>({id:t.id,...t.data()}))}catch(t){return console.error("Error fetching items:",t),u.ZP.error("Failed to load items"),[]}},tt=async()=>{try{return(await (0,b.PL)((0,b.hJ)(S.db,"returns"))).docs.map(t=>t.data().invoiceNumber).reduce((t,e)=>Math.max(t,e),0)+1}catch(t){return console.error("Error fetching last invoice number:",t),1}},te=async()=>{try{return(await (0,b.PL)((0,b.hJ)(S.db,"sales"))).docs.map(t=>({id:t.id,...t.data()})).sort((t,e)=>e.createdAt.seconds-t.createdAt.seconds)}catch(t){return console.error("Error fetching saved invoices:",t),[]}},ta=t=>{r(e=>e.find(e=>e.id===t.id)?e.map(e=>e.id===t.id?{...e,quantity:e.quantity-1,totalAmount:(e.quantity-1)*e.packRetailPrice*(1-e.discount/100)}:e):[...e,{...t,quantity:-1,discount:0,totalAmount:-t.packRetailPrice}]),B("")},tn=()=>{let t=a.reduce((t,e)=>t+e.quantity*e.packRetailPrice,0),e=a.reduce((t,e)=>t+e.quantity*e.packRetailPrice*(e.discount/100),0);return{totalAmount:t,totalDiscount:e,totalQuantity:a.reduce((t,e)=>t+Math.abs(e.quantity||0),0),profit:t-e-a.reduce((t,e)=>t+e.quantity*(e.tpRate||0),0)}},ti=async()=>{if(G)return;V(!0);let{profit:t}=tn();if(t>0){u.ZP.error("Sale is in loss. Please adjust the quantities or prices to make a profit."),V(!1);return}try{let{totalAmount:e,totalDiscount:n,totalQuantity:i}=tn(),r={invoiceNumber:w,customerNumber:E,items:a,totalAmount:e,totalDiscount:n,totalQuantity:i,profit:t,paymentMode:Q,paymentAmount:z,change:z-(e-n),createdAt:(0,b.Bt)()};await (0,b.ET)((0,b.hJ)(S.db,"returns"),r),await Promise.all(a.map(async t=>{let e=(0,b.JU)(S.db,"items",t.id);await (0,b.r7)(e,{stock:t.stock+Math.abs(t.quantity)})})),u.ZP.success("Return saved successfully"),to(r),tr(),V(!1)}catch(t){console.error("Error saving return:",t),u.ZP.error("Failed to save return"),V(!1)}},tr=()=>{r([]),_(""),L("cash"),M(0),q(t=>t+1),B(""),te()},to=t=>{let e=new A.jsPDF;e.setFontSize(18),e.text("M-Siddique Return Point of Sale",14,22),e.setFontSize(12),e.text("Invoice #: ".concat(t.invoiceNumber),14,30),e.text("Customer #: ".concat(t.customerNumber),14,38),e.text("Date: ".concat(new Date().toLocaleString()),14,46);let a=t.items.map(t=>[t.itemName,t.quantity,"₹".concat(t.packRetailPrice.toFixed(2)),"".concat(t.discount,"%"),"₹".concat(t.totalAmount.toFixed(2))]);e.autoTable({head:[["Item","Quantity","Price","Discount","Total"]],body:a,startY:60});let n=e.lastAutoTable.finalY+10;e.text("Total Amount: ₹".concat(t.totalAmount.toFixed(2)),14,n),e.text("Discount: ₹".concat(t.totalDiscount.toFixed(2)),14,n+8),e.text("Total Quantity: ".concat(t.totalQuantity),14,n+8),e.save("return_".concat(t.invoiceNumber,".pdf"))},ts=t.filter(t=>t.itemName.toLowerCase().includes(J.toLowerCase())),tc=async()=>{if(!G){V(!0);try{let{totalAmount:t,totalDiscount:e,totalQuantity:n}=tn(),i={invoiceNumber:w,customerNumber:E,items:a,totalAmount:t,totalDiscount:e,totalQuantity:n,paymentMode:Q,paymentAmount:z,createdAt:(0,b.Bt)()},r=(0,b.JU)(S.db,"returns",H.id);await (0,b.r7)(r,i),u.ZP.success("Return updated successfully"),to(i),tr(),V(!1)}catch(t){console.error("Error updating return:",t),u.ZP.error("Failed to update return"),V(!1)}}},td=t=>{to(t)};return(0,n.jsxs)(s.default,{style:{minHeight:"100vh"},children:[(0,n.jsxs)(F,{style:{background:"#fff",padding:"0 20px",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,n.jsx)(I,{level:2,children:"Return Point of Sale"}),(0,n.jsx)(l.ZP,{type:"default",icon:(0,n.jsx)(v.Z,{}),onClick:()=>X(!0),children:"Saved / Reprint"})]}),(0,n.jsxs)(D,{style:{padding:"20px",overflow:"auto"},children:[(0,n.jsxs)(h.Z,{children:[(0,n.jsxs)(x.Z,{gutter:[16,16],children:[(0,n.jsx)(m.Z,{span:8,children:(0,n.jsxs)(C,{strong:!0,children:["Invoice #: ",w]})}),(0,n.jsx)(m.Z,{span:8,children:(0,n.jsx)(p.Z,{placeholder:"Customer Number",value:E,onChange:t=>_(t.target.value)})}),(0,n.jsx)(m.Z,{span:8,children:(0,n.jsx)(C,{strong:!0,children:new Date().toLocaleString()})})]}),(0,n.jsx)(x.Z,{style:{marginTop:"20px"},children:(0,n.jsx)(m.Z,{span:24,children:(0,n.jsx)(y.Z,{style:{width:"100%"},options:ts.map(t=>({value:t.itemName,label:"".concat(t.itemName," - ₹").concat(t.packRetailPrice.toFixed(2))})),onSelect:e=>{let a=t.find(t=>t.itemName===e);a&&ta(a)},onSearch:t=>{B(t)},placeholder:"Search and select an item",children:(0,n.jsx)(p.Z,{suffix:(0,n.jsx)(k.Z,{})})})})}),(0,n.jsx)("div",{ref:W,style:{maxHeight:"400px",overflowY:"auto",marginTop:"20px"},children:(0,n.jsx)(T,{returnItems:a,onQuantityChange:(t,e)=>{e<0?r(a=>a.map(a=>a.id===t?{...a,quantity:e,totalAmount:e*a.packRetailPrice*(1-a.discount/100)}:a)):u.ZP.error("Quantity must be negative for returns")},onDiscountChange:(t,e)=>{e>=0&&e<=100?r(a=>a.map(a=>a.id===t?{...a,discount:e,totalAmount:a.quantity*a.packRetailPrice*(1-e/100)}:a)):u.ZP.error("Discount must be between 0 and 100")},onDeleteItem:t=>{r(e=>e.filter(e=>e.id!==t))}})}),(0,n.jsx)(R,{style:{position:"sticky",bottom:0,zIndex:1,padding:"10px 20px",background:"#f0f2f5"},children:(0,n.jsxs)(x.Z,{gutter:[16,16],justify:"space-between",align:"middle",children:[(0,n.jsx)(m.Z,{span:12,children:(0,n.jsxs)(f.Z,{direction:"horizontal",children:[(0,n.jsxs)(C,{strong:!0,children:["Total Items: ",a.length]}),(0,n.jsxs)(C,{strong:!0,children:["Total Quantity: ",tn().totalQuantity||0]}),(0,n.jsxs)(C,{strong:!0,children:["Subtotal: ₹",(tn().totalAmount||0).toFixed(2)]}),(0,n.jsxs)(C,{strong:!0,children:["Discount: ₹",(tn().totalDiscount||0).toFixed(2)]}),(0,n.jsxs)(C,{strong:!0,children:["Finalized Total = ₹",((tn().totalAmount||0)-(tn().totalDiscount||0)).toFixed(2)]}),(0,n.jsxs)(C,{strong:!0,children:["Profit: ₹",(tn().profit||0).toFixed(2)]})]})}),(0,n.jsx)(m.Z,{span:12,children:(0,n.jsxs)(f.Z,{direction:"vertical",style:{width:"100%"},children:[(0,n.jsxs)(o.default,{style:{width:"100%"},value:Q,onChange:t=>L(t),children:[(0,n.jsx)(N,{value:"cash",children:"Cash"}),(0,n.jsx)(N,{value:"card",children:"Card"})]}),(0,n.jsx)(d.Z,{style:{width:"100%"},value:z,onChange:t=>M(t),min:0,step:.01,formatter:t=>"₹ ".concat(t).replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:t=>t.replace(/₹\s?|(,*)/g,"")}),(0,n.jsxs)(C,{strong:!0,children:["Change: ₹",Math.max(0,z-(tn().totalAmount-tn().totalDiscount)).toFixed(2)]}),(0,n.jsx)(l.ZP,{type:"primary",icon:(0,n.jsx)(Z.Z,{}),onClick:H?tc:ti,disabled:0===a.length||z<tn().totalAmount-tn().totalDiscount||G,style:{width:"100%"},children:H?"Update Invoice":"Save and Print"}),H&&(0,n.jsx)(l.ZP,{type:"default",onClick:()=>{O(null),tr()},style:{width:"100%",marginTop:"10px"},children:"Cancel"})]})})]})})]}),(0,n.jsx)(j.Z,{title:"Saved Returns",placement:"right",onClose:()=>X(!1),visible:Y,width:400,children:(0,n.jsx)(c.Z,{dataSource:K,columns:[{title:"Invoice #",dataIndex:"invoiceNumber",key:"invoiceNumber"},{title:"Total Amount",dataIndex:"totalAmount",key:"totalAmount",render:t=>"₹".concat(t.toFixed(2))},{title:"Date",dataIndex:"createdAt",key:"createdAt",render:t=>new Date(1e3*t.seconds).toLocaleString()},{title:"Action",key:"action",render:(t,e)=>(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(l.ZP,{type:"link",icon:(0,n.jsx)(P.Z,{}),onClick:()=>td(e)})})}],rowKey:"id",pagination:!1})}),G&&(0,n.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",justifyContent:"center",alignItems:"center"},children:(0,n.jsx)(g.Z,{size:"large"})})]})]})}},94205:function(t,e,a){"use strict";a.d(e,{I:function(){return s},db:function(){return c}});var n=a(83977),i=a(91259),r=a(39828);let o=(0,n.ZF)({apiKey:"AIzaSyCuQ3wNmtDNAZMhZe9MRjpTn1kAvDp4SOA",authDomain:"point-of-sale-8a42d.firebaseapp.com",projectId:"point-of-sale-8a42d",storageBucket:"point-of-sale-8a42d.appspot.com",messagingSenderId:"283428202868",appId:"1:283428202868:web:0c99ca55251c4294136421",measurementId:"G-Q0928NKHEQ"}),s=(0,i.v0)(o),c=(0,r.ad)(o)}},function(t){t.O(0,[16,257,847,837,825,761,335,417,292,861,672,888,774,179],function(){return t(t.s=71605)}),_N_E=t.O()}]);